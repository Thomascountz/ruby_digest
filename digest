#!/usr/bin/env bash
set -euo pipefail

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  echo "Usage: $(basename "$0") [-f|--fetch] [digest]"
  exit 0
fi

if ! git rev-parse --git-dir &>/dev/null; then
  echo "Not a git repository"
  exit 1
fi

if [[ "${1:-}" == "-f" || "${1:-}" == "--fetch" ]]; then
  git fetch -q --tags
  shift
fi

file="${1:-ruby}.md"
if [[ ! -f "$file" ]]; then
  echo "File '$file' does not exist in the current directory."
  exit 1
fi

if command -v fzf &>/dev/null; then
  git tag --sort=-creatordate \
    | fzf --preview "git show {}:$file | bat --style=numbers --color=always --theme auto:system --language=markdown -S 2>/dev/null || git show {}:$file" \
          --preview-window=top:80%:wrap \
    || true
else
  tag=$(git tag --sort=-creatordate | head -1)
  git show "$tag:$file" | ${PAGER:-less}
fi
